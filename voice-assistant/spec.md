# Axis Voice Assistant - 产品规格文档

> 一个运行在 Mac Mini 上的语音交互助手，采用抽象粒子波形可视化，支持语音唤醒、流式对话和情绪色彩反馈。

---

## 1. 产品概述

### 1.1 产品定位
Axis Voice Assistant 是一个本地运行的语音交互界面，通过抽象的粒子波形可视化声音，提供沉浸式的 AI 对话体验。

### 1.2 核心特性
- 🎙️ 语音唤醒（"你好，源宝"）
- 🌊 抽象粒子波形可视化
- 🎨 情绪色彩映射
- 💬 流式对话（打字机效果）
- 🌓 自动深浅主题切换
- 🔌 OpenClaw WebSocket 集成

---

## 2. 技术架构

### 2.1 部署环境
- **主机**: Mac Mini M4 (192.168.31.114)
- **访问范围**: 仅限本机 (localhost)
- **服务方式**: Python http.server 或 Node.js serve

### 2.2 外部服务依赖

| 服务 | 地址 | 用途 | 状态 |
|------|------|------|------|
| ASR | `http://192.168.31.114:9001` | 语音识别 (Whisper MLX) | ✅ 运行中 |
| TTS | `http://192.168.31.114:5100` | 语音合成 (Qwen3-TTS) | ✅ 运行中 |
| OpenClaw | WebSocket | LLM 对话 (Kimi) | 需配置 |

### 2.3 推荐端口
基于 services-logs 扫描，建议以下端口可用：
- `3000` - 开发服务器
- `8081` - 生产服务器（8080 已被占用）

### 2.4 数据流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   麦克风    │────▶│  Web Audio  │────▶│  Mac Mini   │
│   (本地)    │     │   (前端)    │     │  ASR :9001  │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   扬声器    │◀────│  Web Audio  │◀────│  Mac Mini   │
│   (本地)    │     │   (前端)    │     │  TTS :5100  │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │  OpenClaw   │
                                        │  WebSocket  │
                                        │   (Kimi)    │
                                        └─────────────┘
```

---

## 3. UI/UX 设计

### 3.1 整体布局

```
┌─────────────────────────────────────────────────────────┐
│  [⚡] Axis ⚡ AI Assistant          [🌙/☀️] [📊]       │  ← 顶部状态栏
├─────────────────────────────────────────────────────────┤
│                                                         │
│                                                         │
│                                                         │
│              ╭─────────────────────╮                   │
│              │                     │                   │
│              │    粒子波形区域      │                   │  ← 中央可视化
│              │   (占屏幕 40-50%)   │                   │
│              │                     │                   │
│              ╰─────────────────────╯                   │
│                                                         │
│     "你好，源宝，今天天气怎么样？"                       │  ← 用户输入文本
│                                                         │
│     "今天深圳龙华天气晴朗，气温 22-28°C..."             │  ← AI 回复文本
│                                                         │
│                                                         │
│              [ 语音唤醒中... ]                          │  ← 状态提示
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 粒子波形设计

#### 3.2.1 形态
- **形状**: 水平贯穿屏幕的粒子线
- **运动**: 音频波形式上下跳动
- **粒子**: 数百个微小光点组成流动线条

#### 3.2.2 情绪色彩映射

| 状态 | 颜色 | 描述 |
|------|------|------|
| 待机/平静 | `#00d4ff` (科技蓝) | 呼吸状态，5秒周期缓慢浮动 |
| 倾听/输入 | `#00ff88` (活力绿) | 随音量跳动，密度随音量变化 |
| 思考/处理 | `#7b2cbf` (神秘紫) | 快速闪烁，表示 AI 正在思考 |
| 输出/回复 | `#ff6b35` (温暖橙) | 配合打字机效果流动 |
| 打断/停止 | `#ff3366` (警示红) | 闪烁3秒后恢复 |

#### 3.2.3 主题适配

**深色主题** (默认)
- 背景: `linear-gradient(135deg, #0a0a1a 0%, #0d1b2a 50%, #1b263b 100%)`
- 粒子: 高亮度、带发光效果
- 文字: `#e0e1dd`

**浅色主题**
- 背景: `linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 50%, #d1d8e0 100%)`
- 粒子: 降低亮度、减少发光
- 文字: `#2d3748`

### 3.3 文本展示

#### 3.3.1 对话显示
- **只显示当前轮次**: 一问一答
- **打字机效果**: 实时逐字显示
- **颜色区分**:
  - 用户输入: 绿色系 (`#00ff88`)
  - AI 回复: 蓝色系 (`#00d4ff`)

#### 3.3.2 历史淡出
- 新对话开始时，旧对话向上滑动移出
- 同时透明度渐变 + 逐渐变小
- 动画时长: 1秒 ease-out

### 3.4 顶部状态栏

```
┌─────────────────────────────────────────────────────────┐
│ ⚡ Axis ⚡ AI Assistant          🌙  ⏱️ 45ms  🤖 Kimi  │
│                                  ↑   ↑       ↑         │
│                              主题  ASR延迟  模型        │
└─────────────────────────────────────────────────────────┘
```

**显示信息**:
- 左侧: Logo + 标题
- 右侧: 主题图标、ASR延迟、TTS延迟、当前模型、Token数（调试模式）

---

## 4. 交互设计

### 4.1 语音唤醒

#### 唤醒词
- **主唤醒词**: "你好，源宝"
- **打断词**: "等等"、"稍等"、"打断一下"

#### 唤醒流程
```
待机状态 ──▶ 检测到唤醒词 ──▶ 粒子闪烁动效 ──▶ 进入监听状态
   ▲                                              │
   │                                              │
   └── 30秒无输入 ────────────────────────────────┘
```

#### 唤醒后行为
- 粒子线快速闪烁（绿色）表示已唤醒
- 开始监听用户语音输入
- 30秒内无输入自动退出监听状态
- 无提示音，纯视觉反馈

### 4.2 打断机制

#### 触发条件
- 检测到打断词（"等等"、"稍等"、"打断一下"）

#### 打断行为
1. TTS 立即停止播放
2. 粒子线闪烁红色，持续3秒
3. 清空当前对话状态
4. 等待新的语音输入

### 4.3 对话流程

```
┌─────────────┐
│  待机状态   │ ◀──── 粒子缓慢呼吸（蓝色，5秒周期）
└──────┬──────┘
       │ 检测到 "你好，源宝"
       ▼
┌─────────────┐
│  唤醒状态   │ ◀──── 粒子闪烁（绿色）
└──────┬──────┘
       │ 开始录音
       ▼
┌─────────────┐
│  监听输入   │ ◀──── 粒子随音量跳动（绿色，密度变化）
└──────┬──────┘
       │ 发送到 ASR
       ▼
┌─────────────┐
│  识别中     │ ◀──── 短暂过渡
└──────┬──────┘
       │ 文本显示 + 发送给 LLM
       ▼
┌─────────────┐
│  AI 思考    │ ◀──── 粒子快速闪烁（紫色）
└──────┬──────┘
       │ 收到流式回复
       ▼
┌─────────────┐
│  输出回复   │ ◀──── 粒子流动（橙色）+ 打字机效果
└──────┬──────┘
       │ 同时发送 TTS
       ▼
┌─────────────┐
│  语音播放   │ ◀──── 粒子随 TTS 音频跳动
└──────┬──────┘
       │ 播放完成
       ▼
┌─────────────┐
│  回到待机   │
└─────────────┘
```

---

## 5. 技术实现

### 5.1 前端技术栈

| 技术 | 用途 |
|------|------|
| HTML5 | 页面结构 |
| CSS3 | 样式、动画、主题 |
| Vanilla JS | 逻辑控制（无框架依赖） |
| Web Audio API | 麦克风录制、音频播放 |
| Canvas API | 粒子波形渲染 |
| WebSocket | OpenClaw 连接 |

### 5.2 核心模块

#### 5.2.1 ParticleWave (粒子波形)
```javascript
class ParticleWave {
  // 渲染粒子线
  render()
  
  // 设置状态 (idle|listening|thinking|speaking|interrupted)
  setState(state)
  
  // 更新音频数据
  updateAudioData(frequencyData)
  
  // 设置情绪颜色
  setEmotionColor(color)
}
```

#### 5.2.2 VoiceController (语音控制)
```javascript
class VoiceController {
  // 初始化唤醒词检测
  initWakeWord()
  
  // 开始录音
  startRecording()
  
  // 停止录音并发送 ASR
  stopRecording()
  
  // 播放 TTS 音频流
  playTTS(stream)
  
  // 打断当前播放
  interrupt()
}
```

#### 5.2.3 ChatManager (对话管理)
```javascript
class ChatManager {
  // 发送消息到 OpenClaw
  sendMessage(text)
  
  // 处理流式回复
  handleStream(response)
  
  // 显示打字机效果
  typewriterEffect(text)
  
  // 清空当前对话
  clearDialogue()
}
```

#### 5.2.4 ThemeManager (主题管理)
```javascript
class ThemeManager {
  // 检测系统主题
  detectSystemTheme()
  
  // 应用主题
  applyTheme(theme)
  
  // 监听系统主题变化
  watchSystemTheme()
}
```

### 5.3 API 接口

#### 5.3.1 ASR 接口
```http
POST http://192.168.31.114:9001/transcribe
Content-Type: multipart/form-data

file: <audio_blob>
```

#### 5.3.2 TTS 接口
```http
POST http://192.168.31.114:5100/tts
Content-Type: application/x-www-form-urlencoded

text=要合成的文本&voice_id=wangyuan
```

**流式响应**: TTS 返回音频流，前端边接收边播放

#### 5.3.3 OpenClaw WebSocket
```javascript
ws://localhost:<port>/ws  // 需确认 OpenClaw WebSocket 端口
```

---

## 6. 项目结构

```
voice-assistant/
├── index.html          # 主页面
├── spec.md             # 本文档
├── css/
│   └── styles.css      # 样式文件
├── js/
│   ├── main.js         # 入口
│   ├── particle-wave.js    # 粒子波形
│   ├── voice-controller.js # 语音控制
│   ├── chat-manager.js     # 对话管理
│   └── theme-manager.js    # 主题管理
└── assets/
    └── sounds/         # 可选音效
```

---

## 7. 开发计划

### Phase 1: 基础框架
- [ ] 搭建 HTML/CSS 结构
- [ ] 实现主题切换
- [ ] 实现粒子波形基础渲染

### Phase 2: 语音功能
- [ ] 集成 Web Audio API 录音
- [ ] 对接 Mac Mini ASR
- [ ] 实现唤醒词检测

### Phase 3: 对话功能
- [ ] 对接 OpenClaw WebSocket
- [ ] 实现打字机效果
- [ ] 对接 Mac Mini TTS

### Phase 4: 优化完善
- [ ] 粒子动效调优
- [ ] 打断功能实现
- [ ] 状态栏信息显示

---

## 8. 注意事项

### 8.1 浏览器兼容性
- 需要 HTTPS 或 localhost 才能使用麦克风
- 推荐使用 Chrome/Safari/Edge

### 8.2 性能考虑
- 粒子数量控制在 200-500 个，保证 60fps
- Canvas 使用 requestAnimationFrame
- 音频流及时释放内存

### 8.3 错误处理
- ASR/TTS 服务不可用时显示友好提示
- WebSocket 断线自动重连
- 麦克风权限被拒绝时引导用户开启

---

## 9. 附录

### 9.1 唤醒词配置
```javascript
const WAKE_WORDS = ['你好，源宝'];
const INTERRUPT_WORDS = ['等等', '稍等', '打断一下'];
const LISTEN_TIMEOUT = 30000; // 30秒
```

### 9.2 颜色配置
```javascript
const EMOTION_COLORS = {
  idle: { dark: '#00d4ff', light: '#0088cc' },
  listening: { dark: '#00ff88', light: '#00cc66' },
  thinking: { dark: '#7b2cbf', light: '#5a1d8f' },
  speaking: { dark: '#ff6b35', light: '#cc5522' },
  interrupted: { dark: '#ff3366', light: '#cc2244' }
};
```

### 9.3 服务端口记录

**本机 (Ubuntu)**:
- 3000: 可用
- 8081: 可用

**Mac Mini**:
- 5100: Qwen3-TTS ✅
- 9001: Whisper ASR ✅

---

*文档生成时间: 2026-02-05*
*版本: v1.0*
